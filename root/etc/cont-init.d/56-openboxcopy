#!/usr/bin/with-contenv bash

# default setup on first run
[[ ! -f /config/.config/openbox/menu.xml ]] && \
    mkdir -p /config/.config/openbox && \
    cp /defaults/menu.xml /config/.config/openbox/menu.xml && \
    # chown abc:abc /config/.config/openbox/menu.xml && \
    # cp /defaults/menu.xml /etc/xdg/openbox/menu.xml && \
    echo 'export PATH="${PATH}:/config/.local/bin"' >> /config/.bashrc && \
    echo 'export XDG_RUNTIME_DIR=/tmp/runtime-abc' >> /config/.bashrc && \
    echo 'alias uba="/config/UniqueBible/uba.py docker"' >> /config/.bashrc && \
    echo 'alias update="sudo pacman -Syu --noconfirm && sudo updatedb"' >> /config/.bashrc && \
    chown abc:abc /config/.bashrc && \
    chown -R abc:abc /config/.config && \
    chown abc:abc "/defaults/icons/gthumb-icon-300x295.png"
# Download Unique Bible App if it does not exist
[[ ! -d "/config/UniqueBible" ]] && \
    runuser -l abc -c 'git clone https://github.com/eliranwong/UniqueBible /config/UniqueBible' && \
    # The following line is no longer needed.
    # chown -R abc:abc /config/UniqueBible && \
    # Upgrade pip
    runuser -l abc -c 'pip install --no-cache --upgrade pip' && \
    # Avoid the following line, as some issues are noted if some of the packages runs globally.
    # runuser -l abc -c 'pip3 install -r /config/UniqueBible/docker_requirements.txt' && \
    # For some reasons, in docker image, gdown does not work if it is installed in UBA virtualvenv
    # Therefore, gdown is installed globally
    runuser -l abc -c 'pip3 install gdown'
# Install some Unique Bible App files or databases if they do not exist in UBA directory
[[ -f "/defaults/uba/UniqueBibleApp.sh" && ! -f "/config/UniqueBible/UniqueBibleApp.sh" ]] && \
    cp /defaults/uba/UniqueBibleApp.sh /config/UniqueBible/UniqueBibleApp.sh && \
    chmod +x /config/UniqueBible/UniqueBibleApp.sh && \
    chown abc:abc /config/UniqueBible/UniqueBibleApp.sh
[[ -f "/defaults/uba/bibles.sqlite" && ! -f "/config/UniqueBible/marvelData/bibles.sqlite" ]] && \
    cp /defaults/uba/bibles.sqlite /config/UniqueBible/marvelData/bibles.sqlite && \
    chown abc:abc /config/UniqueBible/marvelData/bibles.sqlite && \
    rm /defaults/uba/bibles.sqlite
[[ -f "/defaults/uba/images.sqlite" && ! -f "/config/UniqueBible/marvelData/images.sqlite" ]] && \
    cp /defaults/uba/images.sqlite /config/UniqueBible/marvelData/images.sqlite && \
    chown abc:abc /config/UniqueBible/marvelData/images.sqlite && \
    rm "/defaults/uba/images.sqlite"
[[ -f "/defaults/uba/indexes2.sqlite" && ! -f "/config/UniqueBible/marvelData/indexes2.sqlite" ]] && \
    cp /defaults/uba/indexes2.sqlite /config/UniqueBible/marvelData/indexes2.sqlite && \
    chown abc:abc /config/UniqueBible/marvelData/indexes2.sqlite && \
    rm "/defaults/uba/indexes2.sqlite"
[[ -f "/defaults/uba/morphology.sqlite" && ! -f "/config/UniqueBible/marvelData/morphology.sqlite" ]] && \
    cp /defaults/uba/morphology.sqlite /config/UniqueBible/marvelData/morphology.sqlite && \
    chown abc:abc /config/UniqueBible/marvelData/morphology.sqlite && \
    rm "/defaults/uba/morphology.sqlite"
[[ -f "/defaults/uba/cCBSC.commentary" && ! -f "/config/UniqueBible/marvelData/commentaries/cCBSC.commentary" ]] && \
    cp /defaults/uba/cCBSC.commentary /config/UniqueBible/marvelData/commentaries/cCBSC.commentary && \
    chown abc:abc /config/UniqueBible/marvelData/commentaries/cCBSC.commentary && \
    rm /defaults/uba/cCBSC.commentary
[[ -f "/defaults/uba/wordnet.dct.mybible" && ! -f "/config/UniqueBible/thirdParty/dictionaries/wordnet.dct.mybible" ]] && \
    cp /defaults/uba/wordnet.dct.mybible /config/UniqueBible/thirdParty/dictionaries/wordnet.dct.mybible && \
    chown abc:abc /config/UniqueBible/thirdParty/dictionaries/wordnet.dct.mybible
[[ -f "/defaults/uba/WordNet_Ctrl+Shift+D.py" && ! -f "/config/UniqueBible/plugins/context/WordNet_Ctrl+Shift+D.py" ]] && \
    cp /defaults/uba/WordNet_Ctrl+Shift+D.py /config/UniqueBible/plugins/context/WordNet_Ctrl+Shift+D.py && \
    chown abc:abc /config/UniqueBible/plugins/context/WordNet_Ctrl+Shift+D.py
